<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Markdown Live — Mermaid & PlantUML</title>

  <!-- Reset básico e layout agradável para aula -->
  <style>
    :root { --content-width: 1080px; }
    html, body { margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    body { background:#0b0f14; color:#e6edf3; }
    header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(8px);
      background:rgba(15,23,32,.75); border-bottom:1px solid rgba(255,255,255,.08); }
    header .wrap { max-width: var(--content-width); margin:0 auto; padding:12px 20px; display:flex; gap:12px; align-items:center; }
    header input[type="text"] { flex:1; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0f1520; color:#e6edf3; }
    header button { padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#111827; color:#e6edf3; cursor:pointer; }
    main { max-width: var(--content-width); margin: 24px auto; padding: 0 20px 60px; }
    pre { background:#0f1520; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px; overflow:auto; }
    code { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    img { max-width:100%; }
    .loading { opacity:.7; font-style:italic; }
    .error { color:#ffb4b4; }
    .diagram-note { font-size:12px; opacity:.75; margin-top:-8px; margin-bottom:12px; }
    a { color:#93c5fd; }
    .hidden { display:none; }
  </style>

  <!-- Marked: parse Markdown em HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Mermaid: diagramas em ```mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <!-- PlantUML: encoder + uso de servidor público renderizando <img> -->
  <script src="https://cdn.jsdelivr.net/npm/plantuml-encoder/dist/plantuml-encoder.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <strong>Markdown Live — Mermaid & PlantUML</strong>
      <input id="mdPath" type="text" placeholder="documento.md ou README.md" />
      <button id="btnLoad">Carregar</button>
      <button id="btnFit">Zoom 100%</button>
    </div>
  </header>

  <main>
    <div id="status" class="loading">Carregando documento…</div>
    <article id="content"></article>
    <p class="diagram-note">Mermaid renderiza no cliente. PlantUML é servido via <code>www.plantuml.com/plantuml</code>.</p>
  </main>

<script>
  // ===== Config =====
  const DEFAULT_MD = new URLSearchParams(location.search).get('md') || 'documento.md';
  const PLANTUML_SERVER = 'https://www.plantuml.com/plantuml/svg/'; // png/svg/txt

  // Mermaid init (dark theme automático)
  mermaid.initialize({ startOnLoad: false, theme: 'dark', fontFamily: 'Inter, Roboto, system-ui' });

  const mdPathInput = document.getElementById('mdPath');
  const btnLoad = document.getElementById('btnLoad');
  const btnFit = document.getElementById('btnFit');
  const statusEl = document.getElementById('status');
  const contentEl = document.getElementById('content');

  mdPathInput.value = DEFAULT_MD;

  btnLoad.addEventListener('click', () => loadAndRender(mdPathInput.value.trim() || DEFAULT_MD));
  btnFit.addEventListener('click', () => document.body.style.zoom = '100%');

  // Permite trocar arquivo com Enter
  mdPathInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') btnLoad.click();
  });

  async function loadAndRender(path) {
    try {
      statusEl.classList.remove('hidden'); statusEl.textContent = 'Carregando documento…';
      const res = await fetch(path + '?_=' + Date.now());
      if (!res.ok) throw new Error('Não foi possível carregar: ' + path);
      const md = await res.text();

      // Converte Markdown -> HTML
      const html = marked.parse(md, {
        mangle: false,
        headerIds: true,
        breaks: true
      });

      contentEl.innerHTML = html;

      // Processa blocos de PlantUML: <pre><code class="language-plantuml">...</code></pre>
      await renderPlantUML(contentEl);

      // Processa Mermaid
      await renderMermaid(contentEl);

      statusEl.classList.add('hidden');
    } catch (err) {
      statusEl.classList.remove('hidden');
      statusEl.classList.add('error');
      statusEl.textContent = 'Erro: ' + err.message;
      console.error(err);
    }
  }

  async function renderMermaid(root) {
    const mermaidBlocks = root.querySelectorAll('code.language-mermaid');
    for (const codeEl of mermaidBlocks) {
      const graphDef = codeEl.textContent;
      const pre = codeEl.closest('pre');
      const container = document.createElement('div');
      container.className = 'mermaid';
      container.textContent = graphDef;
      pre.parentNode.replaceChild(container, pre);
    }
    // renderiza tudo
    if (mermaidBlocks.length > 0) {
      await mermaid.run({ querySelector: '.mermaid' });
    }
  }

  async function renderPlantUML(root) {
    const pumlBlocks = root.querySelectorAll('code.language-plantuml, code.language-puml, code.language-uml');
    for (const codeEl of pumlBlocks) {
      const umlText = codeEl.textContent;
      const deflated = plantumlEncoder.encode(umlText);
      const img = document.createElement('img');
      img.loading = 'lazy';
      img.alt = 'PlantUML diagram';
      img.src = PLANTUML_SERVER + deflated;

      const pre = codeEl.closest('pre');
      pre.parentNode.replaceChild(img, pre);
    }
  }

  // Carrega inicial
  loadAndRender(DEFAULT_MD);
</script>
</body>
</html>
